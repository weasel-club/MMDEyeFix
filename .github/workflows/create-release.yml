name: Create Release
on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set tag as version in package.json
        run: |
          VERSION=$(echo "${{ github.ref_name }}")
          echo "Updating package.json version to $VERSION"
          jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp
          cp package.json.tmp package.json

      - name: Make zip
        run: |
          VERSION=$(echo "${{ github.ref_name }}")
          mkdir output
          zip -r "output/MMDEyeFix-${VERSION}.zip" . -x .git/\* -x .github/\* -x output/\*

      - name: Make unitypackage
        run: |
          python3 - <<'PY'
          from pathlib import Path
          import shutil
          import hashlib

          project_root = Path(".")
          output_dir = project_root / "output"
          work_dir = output_dir / "unitypackage"

          include_roots = [
              Path("Editor"),
              Path("Runtime"),
              Path("package.json"),
          ]
          target_root = Path("Assets/MMDEyeFix")

          def read_guid(meta_path: Path) -> str:
              for line in meta_path.read_text(encoding="utf-8").splitlines():
                  if line.startswith("guid: "):
                      return line.split("guid: ", 1)[1].strip()
              raise RuntimeError(f"guid not found in {meta_path}")

          def add_asset(asset_path: Path, target_path: Path) -> None:
              meta_path = asset_path.parent / f"{asset_path.name}.meta"
              if not meta_path.exists():
                  raise RuntimeError(f"Missing meta file: {meta_path}")

              guid = read_guid(meta_path)
              guid_dir = work_dir / guid
              guid_dir.mkdir(parents=True, exist_ok=True)

              if asset_path.is_file():
                  shutil.copy2(asset_path, guid_dir / "asset")

              shutil.copy2(meta_path, guid_dir / "asset.meta")
              (guid_dir / "pathname").write_text(target_path.as_posix(), encoding="utf-8")

          def add_virtual_folder(target_path: Path) -> None:
              guid = hashlib.md5(target_path.as_posix().encode("utf-8")).hexdigest()
              guid_dir = work_dir / guid
              guid_dir.mkdir(parents=True, exist_ok=True)

              folder_meta = (
                  "fileFormatVersion: 2\n"
                  f"guid: {guid}\n"
                  "folderAsset: yes\n"
                  "DefaultImporter:\n"
                  "  externalObjects: {}\n"
                  "  userData: \n"
                  "  assetBundleName: \n"
                  "  assetBundleVariant: \n"
              )
              (guid_dir / "asset.meta").write_text(folder_meta, encoding="utf-8")
              (guid_dir / "pathname").write_text(target_path.as_posix(), encoding="utf-8")

          shutil.rmtree(work_dir, ignore_errors=True)
          work_dir.mkdir(parents=True, exist_ok=True)
          add_virtual_folder(target_root)

          for root in include_roots:
              source = project_root / root
              if not source.exists():
                  continue

              if source.is_file():
                  add_asset(source, target_root / source.name)
                  continue

              stack = [source]
              while stack:
                  current = stack.pop()
                  rel_path = current.relative_to(project_root)
                  add_asset(current, target_root / rel_path)

                  child_dirs = sorted([p for p in current.iterdir() if p.is_dir()], reverse=True)
                  stack.extend(child_dirs)

                  for file_path in sorted([p for p in current.iterdir() if p.is_file() and p.suffix != ".meta"]):
                      rel_file = file_path.relative_to(project_root)
                      add_asset(file_path, target_root / rel_file)
          PY

          chmod -R 777 output/unitypackage
          cd output/unitypackage
          tar -cf ../archtemp.tar *
          cd ..
          gzip -1 -f archtemp.tar
          mv archtemp.tar.gz "MMDEyeFix-${{ github.ref_name }}.unitypackage"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./output/MMDEyeFix-${{ github.ref_name }}.zip
            ./output/MMDEyeFix-${{ github.ref_name }}.unitypackage
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          name: MMDEyeFix-${{ github.ref_name }}

      - name: Trigger packages workflow
        uses: convictional/trigger-workflow-and-wait@v1.6.1
        with:
          owner: weasel-club
          repo: packages
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          workflow_file_name: build-listing.yml
          ref: main
          trigger_workflow: true
          wait_workflow: true
